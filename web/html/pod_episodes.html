<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Podcast Episodes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"  crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="/css/pod_episodes.css">
</head>
<body>
  <div class="page-shell">
    <header class="header">
      <h1 id="pod-title">Podcast Episodes</h1>
      <p class="subtitle" id="pod-subtitle">Loading podcast infoâ€¦</p>
    </header>

    <div class="status" id="status"></div>

    <div class="table-container">
      <table id="episodes-table" class="display table table-striped" style="width:100%">
        <thead>
          <tr>
            <th>Index</th>
            <th>Title</th>
            <th>Duration</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"  crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script>
    (function() {
      const statusEl = document.getElementById('status');
      const titleEl = document.getElementById('pod-title');
      const subtitleEl = document.getElementById('pod-subtitle');
      const params = new URLSearchParams(window.location.search);
      const podId = params.get('pod_id');

      function showStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        statusEl.style.borderColor = isError ? '#f5c2c7' : '#e6e9f2';
        statusEl.style.background = isError ? '#fff5f5' : '#fff';
        statusEl.style.color = isError ? '#842029' : '#4b5675';
      }

      async function recordLocation() {
        console.log("recordLocation for pod_episodes");
        const uri = `${window.location.pathname}${window.location.search}`;
        try {
          await fetch('/api/last_location', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uri })
          });
        } catch (err) {
          console.warn('Failed to record last location', err);
        }
      }

      async function loadPod() {
        if (!podId) {
          showStatus('Missing pod_id in URL.', true);
          subtitleEl.textContent = 'Unable to load episodes.';
          return;
        }

        showStatus('Loading episodes...');
        try {
          const res = await fetch('/api/get_pods', { credentials: 'include' });
          if (!res.ok) throw new Error(`Request failed: ${res.status}`);
          const pods = await res.json();
          const pod = pods.find(p => p.id === podId);
          if (!pod) {
            showStatus('Podcast not found.', true);
            subtitleEl.textContent = 'Unable to load episodes.';
            return;
          }

          titleEl.textContent = pod.title || 'Podcast';
          subtitleEl.textContent = pod.episodes?.length
            ? `${pod.episodes.length} episode${pod.episodes.length === 1 ? '' : 's'}`
            : 'No episodes found.';

          const rows = (pod.episodes || []).map(ep => ([
            ep.index || '',
            ep.title || 'Untitled',
            ep.duration || '',
            `
              <div class="actions">
                <button type="button" class="btn btn-sm btn-outline-primary">
                  <i class="fa-solid fa-play"></i> Play
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary btn-add-queue"
                        data-episode-idx="${ep.index || ''}">
                  <i class="fa-solid fa-list-ul"></i> Add to queue
                </button>
              </div>
            `
          ]));

          $('#episodes-table').DataTable({
            data: rows,
            columns: [
              { title: 'Index' },
              { title: 'Title' },
              { title: 'Duration' },
              { title: 'Actions', orderable: false }
            ],
            paging: true,
            pageLength: 10,
            order: rows.length ? [[0, 'asc']] : [],
            searching: false,
            info: false,
            lengthChange: false
          });

          statusEl.style.display = 'none';
        } catch (err) {
          showStatus('Failed to load episodes.', true);
          console.error(err);
        }
      }

      async function addToQueue(episodeIdx) {
        if (!episodeIdx) {
          showStatus('Cannot add episode without an index.', true);
          return;
        }
        try {
          const res = await fetch('/api/queue', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              pod_id: podId,
              episode_idx: Number(episodeIdx),
              start_pos: 0
            })
          });
          if (!res.ok) throw new Error(`Request failed: ${res.status}`);
          const data = await res.json();
          if (!data.added) {
            showStatus('Episode is already in your queue.', false);
          } else {
            statusEl.style.display = 'none';
          }
        } catch (err) {
          showStatus('Failed to add to queue.', true);
          console.error(err);
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        recordLocation();
        loadPod();
        $('#episodes-table').on('click', '.btn-add-queue', function () {
          const idx = this.getAttribute('data-episode-idx');
          addToQueue(idx);
        });
      });
    })();
  </script>
</body>
</html>
