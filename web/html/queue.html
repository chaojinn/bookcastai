<!--
use GET /api/queue to get all queued episodes
use jquery datatables from cdn to display these episodes according to idx
table should not have paging, display all episodes, use scrollbar if needed.
for each row, it should have a move up / a move down / and a remove button
use icon from fontawesome for button, not text needed for button
table should look nice on all screen sizes
use jquery and bootstrap from cdn
don't remove this comment after generating code

-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queue</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <style>
    body {
      background: #f6f7fb;
      color: #1f2430;
    }
    .page-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 56px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 16px;
    }
    .header h2 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .status-bar {
      display: none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e2e8f4;
      background: #fff;
      color: #334155;
      margin-bottom: 14px;
      font-size: 0.95rem;
    }
    .table-card {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e2e8f4;
      box-shadow: 0 8px 26px rgba(15, 23, 42, 0.05);
      padding: 12px;
    }
    .dataTables_wrapper .dataTables_scrollBody {
      border-radius: 8px;
      border: 1px solid #eef1f7;
    }
    #queue-table {
      width: 100% !important;
    }
    .actions-col .btn {
      margin: 0 3px;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <div class="header">
      <div>
        <h2>Queue</h2>
        <p class="text-muted mb-0">Manage the order of upcoming episodes.</p>
      </div>
      <button class="btn btn-outline-primary btn-sm" id="refresh-btn">
        <i class="fa-solid fa-rotate-right me-1"></i> Refresh
      </button>
    </div>

    <div id="status" class="status-bar"></div>

    <div class="table-card">
      <table id="queue-table" class="display table table-striped align-middle">
        <thead>
          <tr>
            <th>Position</th>
            <th>Podcast ID</th>
            <th>Episode</th>
            <th>Start</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script>
    (function() {
      let table;
      const statusEl = document.getElementById('status');
      const refreshBtn = document.getElementById('refresh-btn');

      function showStatus(message, variant = 'info') {
        statusEl.textContent = message;
        statusEl.style.display = message ? 'block' : 'none';
        const colors = {
          info: ['#e2e8f4', '#fff', '#334155'],
          success: ['#d1e7dd', '#f6fffb', '#0f5132'],
          warning: ['#ffeeba', '#fffdf4', '#664d03'],
          danger: ['#f5c2c7', '#fff5f5', '#842029'],
          muted: ['#e2e8f4', '#fff', '#6c757d']
        };
        const [border, bg, text] = colors[variant] || colors.info;
        statusEl.style.borderColor = border;
        statusEl.style.background = bg;
        statusEl.style.color = text;
      }

      async function recordLocation() {
        const uri = `${window.location.pathname}${window.location.search}`;
        try {
          await fetch('/api/last_location', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uri })
          });
        } catch (err) {
          console.warn('Failed to record last location', err);
        }
      }

      function formatSeconds(seconds) {
        if (!Number.isFinite(seconds) || seconds < 0) return 'â€”';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function renderTable(items) {
        const rows = items.map((item, idx) => {
          const isFirst = idx === 0;
          const isLast = idx === items.length - 1;
          return [
            item.idx,
            item.pod_id || 'Unknown',
            item.episode_idx ?? '',
            formatSeconds(Number(item.start_pos) || 0),
            `
              <div class="actions-col d-flex justify-content-center">
                <button class="btn btn-sm btn-outline-secondary btn-move"
                        data-idx="${item.idx}"
                        data-direction="up"
                        title="Move up"
                        ${isFirst ? 'disabled' : ''}>
                  <i class="fa-solid fa-arrow-up"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary btn-move"
                        data-idx="${item.idx}"
                        data-direction="down"
                        title="Move down"
                        ${isLast ? 'disabled' : ''}>
                  <i class="fa-solid fa-arrow-down"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger btn-remove"
                        data-idx="${item.idx}"
                        title="Remove from queue">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            `
          ];
        });

        if (table) {
          table.clear().rows.add(rows).draw();
        } else {
          table = $('#queue-table').DataTable({
            data: rows,
            columns: [
              { title: 'Position', className: 'text-center fw-semibold' },
              { title: 'Podcast ID' },
              { title: 'Episode', className: 'text-center' },
              { title: 'Start', className: 'text-center' },
              { title: '', orderable: false, searchable: false, className: 'text-center' }
            ],
            paging: false,
            info: false,
            searching: false,
            ordering: false,
            autoWidth: false,
            scrollY: '55vh',
            scrollCollapse: true,
            responsive: true,
            deferRender: true
          });
        }

        if (items.length === 0) {
          showStatus('Your queue is empty.', 'muted');
        } else {
          showStatus('', 'info');
        }
      }

      async function loadQueue() {
        try {
          showStatus('Loading queue...');
          const res = await fetch('/api/queue', { credentials: 'include' });
          if (!res.ok) throw new Error(`Request failed: ${res.status}`);
          const items = await res.json();
          renderTable(Array.isArray(items) ? items : []);
          if (items.length) {
            showStatus('Queue loaded.', 'success');
            setTimeout(() => showStatus('', 'info'), 900);
          }
        } catch (err) {
          console.error(err);
          showStatus('Failed to load queue.', 'danger');
        }
      }

      async function moveItem(idx, direction) {
        try {
          const res = await fetch('/api/queue/move', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idx, direction })
          });
          if (!res.ok) throw new Error(`Request failed: ${res.status}`);
          const data = await res.json();
          if (!data.moved) {
            showStatus('Cannot move item further.', 'warning');
          }
          await loadQueue();
        } catch (err) {
          console.error(err);
          showStatus('Failed to move item.', 'danger');
        }
      }

      async function removeItem(idx) {
        try {
          const res = await fetch(`/api/queue/${idx}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          if (!res.ok) throw new Error(`Request failed: ${res.status}`);
          const data = await res.json();
          if (!data.removed) {
            showStatus('Unable to remove item.', 'warning');
          }
          await loadQueue();
        } catch (err) {
          console.error(err);
          showStatus('Failed to remove item.', 'danger');
        }
      }

      function bindHandlers() {
        $('#queue-table').on('click', '.btn-move', function () {
          const idx = Number(this.getAttribute('data-idx'));
          const direction = this.getAttribute('data-direction');
          if (idx && direction) moveItem(idx, direction);
        });

        $('#queue-table').on('click', '.btn-remove', function () {
          const idx = Number(this.getAttribute('data-idx'));
          if (idx) removeItem(idx);
        });

        refreshBtn.addEventListener('click', loadQueue);
      }

      window.addEventListener('DOMContentLoaded', () => {
        recordLocation();
        bindHandlers();
        loadQueue();
      });
    })();
  </script>
</body>
</html>
