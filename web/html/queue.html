<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Queue</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/epub.css">
</head>
<body>
  <main class="page-shell">
    <header class="page-header">
      <div>
        <h1>Job Queue</h1>
        <p class="subtitle">Live status of background jobs</p>
      </div>
      <div id="refresh-spinner" class="text-secondary d-none">
        <i class="fa-solid fa-rotate fa-spin"></i> Refreshing…
      </div>
    </header>

    <!-- Summary counts -->
    <section class="panel">
      <div class="row g-3 text-center">
        <div class="col-4">
          <div class="border rounded p-3">
            <div class="fs-2 fw-bold" id="count-waiting">—</div>
            <div class="text-secondary small">Waiting</div>
          </div>
        </div>
        <div class="col-4">
          <div class="border rounded p-3 border-primary">
            <div class="fs-2 fw-bold text-primary" id="count-running">—</div>
            <div class="text-secondary small">Running</div>
          </div>
        </div>
        <div class="col-4">
          <div class="border rounded p-3">
            <div class="fs-2 fw-bold" id="count-done">—</div>
            <div class="text-secondary small">Done</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Current running job -->
    <section class="panel d-none" id="running-panel">
      <h6 class="mb-3">Current Job</h6>
      <div class="d-flex justify-content-between mb-1">
        <span id="running-command" class="fw-semibold"></span>
        <span id="running-pct" class="text-secondary small"></span>
      </div>
      <div class="progress mb-2" style="height: 18px;">
        <div
          id="running-bar"
          class="progress-bar progress-bar-striped progress-bar-animated"
          style="width: 0%"
        ></div>
      </div>
      <div id="running-msg" class="text-secondary small"></div>
    </section>

    <!-- Job list -->
    <section class="panel">
      <h6 class="mb-3">All Jobs</h6>
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Command</th>
              <th>Status</th>
              <th style="width:160px">Progress</th>
              <th>Started</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="jobs-tbody">
            <tr id="no-jobs-row">
              <td colspan="5" class="text-center text-secondary py-4">No jobs yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/main.js"></script>
  <script>
    const BADGE = {
      queued:    'secondary',
      running:   'primary',
      success:   'success',
      fail:      'danger',
      cancelled: 'warning',
    };

    function statusBadge(status) {
      const color = BADGE[status] || 'secondary';
      return `<span class="badge bg-${color}">${status}</span>`;
    }

    function fmtTime(iso) {
      if (!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function render(jobs) {
      const waiting = jobs.filter(j => j.status === 'queued').length;
      const running = jobs.filter(j => j.status === 'running').length;
      const done    = jobs.filter(j => ['success', 'fail', 'cancelled'].includes(j.status)).length;

      $('#count-waiting').text(waiting);
      $('#count-running').text(running);
      $('#count-done').text(done);

      // Running panel
      const activeJob = jobs.find(j => j.status === 'running');
      if (activeJob) {
        $('#running-panel').removeClass('d-none');
        $('#running-command').text(activeJob.command);
        const pct = activeJob.progress ?? 0;
        $('#running-pct').text(`${pct}%`);
        $('#running-bar').css('width', `${pct}%`).attr('aria-valuenow', pct);
        $('#running-msg').text(activeJob.progress_msg || '');
      } else {
        $('#running-panel').addClass('d-none');
      }

      // Job table
      const tbody = $('#jobs-tbody');
      tbody.empty();
      if (jobs.length === 0) {
        tbody.append('<tr><td colspan="5" class="text-center text-secondary py-4">No jobs yet.</td></tr>');
        return;
      }
      jobs.forEach(j => {
        const pct = j.progress ?? 0;
        const bar = j.status === 'running'
          ? `<div class="progress" style="height:10px"><div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width:${pct}%"></div></div>`
          : j.status === 'success'
            ? `<div class="progress" style="height:10px"><div class="progress-bar bg-success" style="width:100%"></div></div>`
            : `<div class="text-secondary small">${pct}%</div>`;
        tbody.append(`
          <tr>
            <td class="font-monospace small">${$('<span>').text(j.command).html()}</td>
            <td>${statusBadge(j.status)}</td>
            <td>${bar}</td>
            <td class="text-secondary small text-nowrap">${fmtTime(j.started_at)}</td>
            <td class="text-secondary small">${$('<span>').text(j.progress_msg || '').html()}</td>
          </tr>
        `);
      });
    }

    async function loadJobs() {
      $('#refresh-spinner').removeClass('d-none');
      try {
        const res = await fetchWithRefresh('/api/jobs');
        if (!res.ok) throw new Error('Failed to fetch jobs');
        const jobs = await res.json();
        render(jobs);
      } catch (err) {
        console.warn('Failed to load jobs', err);
      } finally {
        $('#refresh-spinner').addClass('d-none');
      }
    }

    $(function () {
      loadJobs();
      setInterval(loadJobs, 2000);
    });
  </script>
</body>
</html>
