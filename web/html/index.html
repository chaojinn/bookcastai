<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookcastAI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"  crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"  crossorigin="anonymous">
  <link rel="stylesheet" href="/css/index.css">
</head>
<body>
  <header class="topbar">
    <h1 class="title">BookcastAI</h1>
    <div class="actions">
      <div class="dropdown">
        <button class="icon-btn dropdown-toggle" id="menu-dropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menu">
          <i class="fa-solid fa-bars"></i><span>Menu</span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="menu-dropdown">
          <li>
            <a class="dropdown-item menu-link" href="#" data-target="/library.html">
              <i class="fa-solid fa-book"></i> Library
            </a>
          </li>
          <li>
            <a class="dropdown-item menu-link" href="#" data-target="/book_upload.html">
              <i class="fa-solid fa-file-arrow-up"></i> Upload book
            </a>
          </li>
          <li>
            <button class="dropdown-item" type="button" id="logoff-menu">
              <i class="fa-solid fa-right-from-bracket"></i> Log off
            </button>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <div class="frame-wrap">
    <iframe id="content-frame" src="" title="Content"></iframe>
    <div id="player-container" class="player-container" style="display: none;">
      <iframe id="player-frame" title="Player" src="/player.html" scrolling="no"></iframe>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"  crossorigin="anonymous"></script>
  <script src="/js/main.js"></script>
  <script>
    const frame = document.getElementById('content-frame');

    function setFrameTarget(target) {
      frame.src = target || '';
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.getAttribute('data-target') === target) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.querySelectorAll('.menu-link').forEach((link) => {
      link.addEventListener('click', (ev) => {
        ev.preventDefault();
        const target = link.getAttribute('data-target');
        setFrameTarget(target);
      });
    });

    const playerContainer = document.getElementById('player-container');
    const playerFrame = document.getElementById('player-frame');
    let playerVisible = false;
    let playerMode = 'collapsed';

    function applyPlayerHeight() {
      playerFrame.style.height = playerMode === 'expanded' ? '60vh' : '25vh';
    }

    function setPlayerVisible(show) {
      if (show) {
        if (!playerVisible) {
          playerContainer.style.display = 'block';
          applyPlayerHeight();
          playerVisible = true;
          if (!playerFrame.src) {
            playerFrame.src = '/player.html';
          }
        }
      } else {
        playerContainer.style.display = 'none';
        playerVisible = false;
      }
    }

    async function loadPlayerQueue() {
      try {
        const res = await fetchWithRefresh('/api/queue');
        if (!res.ok) throw new Error('queue request failed');
        const data = await res.json();
        setPlayerVisible(Array.isArray(data) && data.length > 0);
      } catch (err) {
        console.warn('Failed to load queue', err);
        setPlayerVisible(false);
      }
    }

    async function loadLastLocation() {
      try {
        const res = await fetchWithRefresh('/api/last_location');
        if (!res.ok) throw new Error('last_location request failed');
        const data = await res.json();
        console.log("last_location:");
        console.log(data);
        if (data?.uri) {
          setFrameTarget(data.uri);
        }
      } catch (err) {
        console.warn('Failed to load last location', err);
      }
    }

    window.addEventListener('message', (event) => {
      if (!event?.data || !event.data.type) return;
      if (event.data.type === 'player-new-mode') {
        playerMode = event.data.mode === 'expanded' ? 'expanded' : 'collapsed';
        if (playerVisible) applyPlayerHeight();
      }
      if (event.data.type === 'navigate-content') {
        setFrameTarget(event.data.url);
      }
      if (event.data.type === 'queue-updated') {
        loadPlayerQueue();
        if (playerFrame?.contentWindow) {
          playerFrame.contentWindow.postMessage({ type: 'reload-queue' }, '*');
        }
        if (frame?.contentWindow) {
          try {
            const path = frame.contentWindow.location?.pathname || '';
            if (path.endsWith('/pod_episodes.html')) {
              frame.contentWindow.postMessage({ type: 'queue-updated' }, '*');
            }
          } catch (err) {
            console.warn('Failed to notify content frame about queue update', err);
          }
        }
      }
    });

 
    const logoffMenu = document.getElementById('logoff-menu');

    async function handleLogoff() {
      try {
        const res = await fetchWithRefresh('/api/logoff', {
          method: 'POST',
        });
        if (res.ok) {
          window.location.href = '/login.html';
        } else {
          alert('Failed to log off. Please try again.');
        }
      } catch (err) {
        alert('Network error. Please try again.');
      }
    }

    if (logoffMenu) {
      logoffMenu.addEventListener('click', handleLogoff);
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadLastLocation();
      loadPlayerQueue();
    });
  </script>
</body>
</html>
