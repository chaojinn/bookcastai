<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clip</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/clip.css">
</head>
<body>
  <div class="clip-page">
    <div class="clip-header">
      <button id="back-btn"><i class="fa-solid fa-arrow-left"></i> Back</button>
      <h4>Clip from <span id="pod-title"></span></h4>
    </div>

    <!-- Step 1: Transcription -->
    <div id="step1">
      <div id="clip-status" class="clip-status">Transcribing audio...</div>
      <div id="clip-hint" class="clip-hint" style="display:none;">Click a word to set the start, then click another to set the end of your clip.</div>
      <div id="clip-words" class="clip-words" style="display:none;"></div>
      <div id="selection-info" class="selection-info" style="display:none;">
        Selected: <span id="sel-start"></span> &ndash; <span id="sel-end"></span>
        &nbsp;(<span id="sel-duration"></span>)
      </div>
      <div class="clip-actions">
        <button id="create-video-btn" class="btn btn-primary" style="display:none;">
          <i class="fa-solid fa-film"></i> Create Video
        </button>
      </div>
    </div>

    <!-- Step 2: Video Result -->
    <div id="step2" style="display:none;">
      <div id="video-status" class="video-status">Generating video...</div>
      <div id="video-result" class="video-result" style="display:none;">
        <video id="video-player" controls></video>
        <a id="video-download" class="btn btn-outline-primary" download>
          <i class="fa-solid fa-download"></i> Download
        </a>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/main.js"></script>
  <script>
    (() => {
      const params = new URLSearchParams(window.location.search);
      const podTitle = params.get('pod_title') || '';
      const timestamp = parseFloat(params.get('timestamp') || '0');
      const audioUrl = params.get('audio_url') || '';
      const podId = params.get('pod_id') || '';
      const episodeIdx = parseInt(params.get('episode_idx') || '0', 10);

      document.getElementById('pod-title').textContent = podTitle;

      let allWords = [];
      let clipStart = 0;
      let clipEnd = 0;
      let selStartIdx = null;
      let selEndIdx = null;

      function formatSeconds(s) {
        if (!Number.isFinite(s) || s < 0) return '0:00';
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return m + ':' + String(sec).padStart(2, '0');
      }

      async function fetchTranscription() {
        const status = document.getElementById('clip-status');
        try {
          const res = await fetchWithRefresh('/api/clip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              audio_url: audioUrl,
              timestamp: timestamp,
              pod_id: podId,
              episode_idx: episodeIdx,
            }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Request failed');
          }
          const data = await res.json();
          allWords = data.words || [];
          clipStart = data.clip_start;
          clipEnd = data.clip_end;
          renderWords();
        } catch (err) {
          status.textContent = 'Error: ' + err.message;
        }
      }

      function renderWords() {
        const status = document.getElementById('clip-status');
        const hint = document.getElementById('clip-hint');
        const container = document.getElementById('clip-words');
        status.style.display = 'none';
        container.style.display = '';

        if (!allWords.length) {
          container.textContent = 'No speech detected in this clip.';
          return;
        }

        hint.style.display = '';
        container.innerHTML = '';
        allWords.forEach((w, idx) => {
          const span = document.createElement('span');
          span.className = 'clip-word';
          span.textContent = w.word + ' ';
          span.title = formatSeconds(w.start) + ' - ' + formatSeconds(w.end);
          span.dataset.idx = idx;
          span.addEventListener('click', () => handleWordClick(idx));
          container.appendChild(span);
        });
      }

      function handleWordClick(idx) {
        if (selStartIdx === null) {
          selStartIdx = idx;
          selEndIdx = null;
        } else if (selEndIdx === null) {
          if (idx < selStartIdx) {
            selEndIdx = selStartIdx;
            selStartIdx = idx;
          } else {
            selEndIdx = idx;
          }
        } else {
          selStartIdx = idx;
          selEndIdx = null;
        }
        updateSelectionDisplay();
      }

      function updateSelectionDisplay() {
        document.querySelectorAll('.clip-word').forEach(span => {
          const i = parseInt(span.dataset.idx);
          span.classList.remove('selected', 'range');
          if (selStartIdx !== null && selEndIdx !== null) {
            if (i >= selStartIdx && i <= selEndIdx) span.classList.add('range');
            if (i === selStartIdx || i === selEndIdx) span.classList.add('selected');
          } else if (selStartIdx !== null && i === selStartIdx) {
            span.classList.add('selected');
          }
        });

        const info = document.getElementById('selection-info');
        const btn = document.getElementById('create-video-btn');

        if (selStartIdx !== null && selEndIdx !== null) {
          const sTime = allWords[selStartIdx].start;
          const eTime = allWords[selEndIdx].end;
          document.getElementById('sel-start').textContent = formatSeconds(sTime);
          document.getElementById('sel-end').textContent = formatSeconds(eTime);
          document.getElementById('sel-duration').textContent = formatSeconds(eTime - sTime);
          info.style.display = '';
          btn.style.display = '';
        } else {
          info.style.display = 'none';
          btn.style.display = 'none';
        }
      }

      document.getElementById('create-video-btn').addEventListener('click', async () => {
        const startTime = allWords[selStartIdx].start;
        const endTime = allWords[selEndIdx].end;
        const selectedWords = allWords.slice(selStartIdx, selEndIdx + 1);

        const step2 = document.getElementById('step2');
        const videoStatus = document.getElementById('video-status');
        const videoResult = document.getElementById('video-result');
        const btn = document.getElementById('create-video-btn');

        step2.style.display = '';
        videoStatus.style.display = '';
        videoStatus.textContent = 'Generating video...';
        videoResult.style.display = 'none';
        btn.disabled = true;

        try {
          const res = await fetchWithRefresh('/api/clip_video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              audio_url: audioUrl,
              timestamp: timestamp,
              pod_id: podId,
              pod_title: podTitle,
              episode_idx: episodeIdx,
              start_time: startTime,
              end_time: endTime,
              words: selectedWords,
            }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Request failed');
          }
          const data = await res.json();

          videoStatus.style.display = 'none';
          videoResult.style.display = '';
          document.getElementById('video-player').src = data.video_url;
          document.getElementById('video-download').href = data.video_url;
        } catch (err) {
          videoStatus.textContent = 'Error: ' + err.message;
        } finally {
          btn.disabled = false;
        }
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        window.parent?.postMessage({ type: 'navigate-content', url: '/library.html' }, '*');
      });

      fetchTranscription();
    })();
  </script>
</body>
</html>
